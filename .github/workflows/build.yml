name: Build

on:
  push:
    branches: [ master, imlib2-multiframe ]
  pull_request:
    branches: [ master ]

# NOTE: "stable" tcc is too old and fails at linking. instead fetching a recent known working commit.
jobs:
  full-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: dep
      run: |
        sudo apt-get update
        sudo apt-get install libimlib2 libimlib2-dev xserver-xorg-core xserver-xorg-dev \
                             libxft2 libxft-dev libexif12 libexif-dev \
                             gcc clang git
        TCC_SHA="027b8fb9b88fe137447fb8bb1b61079be9702472"
        wget "https://github.com/TinyCC/tinycc/archive/${TCC_SHA}.tar.gz" && tar xzf "${TCC_SHA}.tar.gz"
        ( cd "tinycc-$TCC_SHA" && ./configure && make && sudo make install; )
        # TODO: remove before merging to master
        git clone --depth 1 'http://git.enlightenment.org/old/legacy-imlib2.git' imlib2
        ( cd imlib2 && ./autogen.sh && make && sudo make install )
    - name: build
      run: |
        # vanilla flags
        CFLAGS="-std=c99 -Wall -pedantic"
        # extra flags
        CFLAGS+=" -O3 -flto"
        CFLAGS+=" -Werror -Wextra -Wshadow -Wvla -Wpointer-arith"
        CFLAGS+=" -Wundef -Wstrict-overflow=4 -Wwrite-strings -Wunreachable-code"
        CFLAGS+=" -Wbad-function-cast -Wdeclaration-after-statement"
        CFLAGS+=" -Wmissing-prototypes -Wstrict-prototypes"
        # silence
        CFLAGS+=" -Wno-sign-compare -Wno-unused-parameter -Wno-missing-field-initializers"
        echo "###  GCC BUILD  ###" && make clean && make -s CC=gcc   CFLAGS="$CFLAGS" LDFLAGS="$CFLAGS" OPT_DEP_DEFAULT=1
        echo "### CLANG BUILD ###" && make clean && make -s CC=clang CFLAGS="$CFLAGS" LDFLAGS="$CFLAGS" OPT_DEP_DEFAULT=1
        echo "###  TCC BUILD  ###" && make clean && make -s CC=tcc   CFLAGS="$CFLAGS" LDFLAGS="$CFLAGS" OPT_DEP_DEFAULT=1

  minimal-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: dep
      run: |
        sudo apt-get update
        sudo apt-get install libimlib2 libimlib2-dev xserver-xorg-core xserver-xorg-dev \
                             gcc clang git
        sudo apt-get remove libxft2 libxft-dev libexif12 libexif-dev
        TCC_SHA="027b8fb9b88fe137447fb8bb1b61079be9702472"
        wget "https://github.com/TinyCC/tinycc/archive/${TCC_SHA}.tar.gz" && tar xzf "${TCC_SHA}.tar.gz"
        ( cd "tinycc-$TCC_SHA" && ./configure && make && sudo make install; )
        # TODO: remove before merging to master
        git clone --depth 1 'http://git.enlightenment.org/old/legacy-imlib2.git' imlib2
        ( cd imlib2 && ./autogen.sh && make && sudo make install )
    - name: build
      run: |
        # vanilla flags
        CFLAGS="-std=c99 -Wall -pedantic"
        # extra flags
        CFLAGS+=" -O3 -flto"
        CFLAGS+=" -Werror -Wextra -Wshadow -Wvla -Wpointer-arith"
        CFLAGS+=" -Wundef -Wstrict-overflow=4 -Wwrite-strings -Wunreachable-code"
        CFLAGS+=" -Wbad-function-cast -Wdeclaration-after-statement"
        CFLAGS+=" -Wmissing-prototypes -Wstrict-prototypes"
        # silence
        CFLAGS+=" -Wno-sign-compare -Wno-unused-parameter -Wno-missing-field-initializers"
        echo "###  GCC BUILD  ###" && make clean && make -s CC=gcc   CFLAGS="$CFLAGS" LDFLAGS="$CFLAGS" OPT_DEP_DEFAULT=0
        echo "### CLANG BUILD ###" && make clean && make -s CC=clang CFLAGS="$CFLAGS" LDFLAGS="$CFLAGS" OPT_DEP_DEFAULT=0
        echo "###  TCC BUILD  ###" && make clean && make -s CC=tcc   CFLAGS="$CFLAGS" LDFLAGS="$CFLAGS" OPT_DEP_DEFAULT=0
